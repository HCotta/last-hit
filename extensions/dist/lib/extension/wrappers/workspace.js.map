{"version":3,"sources":["../lib/extension/wrappers/workspace.ts"],"names":[],"mappings":"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","file":"workspace.js","sourcesContent":["import { WorkspaceExtensions } from 'last-hit-types';\nimport {\n\tAbstractExtensionEntryPointWrapper,\n\tIExtensionEntryPointHelper,\n\tExtensionEventTypes\n} from '../../types';\n\nexport type EventHandler<E extends WorkspaceExtensions.WorkspaceEvent> =\n\t| ((event: E) => Promise<any>)\n\t| ((\n\t\t\tevent: E,\n\t\t\tbrowserHelper: WorkspaceExtensions.IWorkspaceExtensionBrowserHelper\n\t  ) => Promise<any>);\n\nclass BrowserHelper implements WorkspaceExtensions.IWorkspaceExtensionBrowserHelper {\n\tprivate helper: IExtensionEntryPointHelper;\n\tconstructor(helper: IExtensionEntryPointHelper) {\n\t\tthis.helper = helper;\n\t}\n\tgetHelper(): IExtensionEntryPointHelper {\n\t\treturn this.helper;\n\t}\n\tgetElementAttrValue(\n\t\tcsspath: string,\n\t\tattrName: string,\n\t\tpageUuid?: string\n\t): Promise<string | null> {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tlet timeout;\n\t\t\tconst onValue = (value: string | null) => {\n\t\t\t\tif (timeout) {\n\t\t\t\t\tclearTimeout(timeout);\n\t\t\t\t}\n\t\t\t\tresolve(value);\n\t\t\t};\n\t\t\tthis.helper.once(ExtensionEventTypes.BROWSER_OPERATION, onValue);\n\t\t\tthis.helper.sendBrowserOperation({\n\t\t\t\ttype: 'get-element-attr-value',\n\t\t\t\tcsspath,\n\t\t\t\tattrName,\n\t\t\t\tpageUuid\n\t\t\t});\n\t\t\ttimeout = setTimeout(() => {\n\t\t\t\tthis.helper.off(ExtensionEventTypes.BROWSER_OPERATION, onValue);\n\t\t\t\treject(new Error('Timeout'));\n\t\t\t}, 5000);\n\t\t});\n\t}\n\tgetElementPropValue(\n\t\tcsspath: string,\n\t\tpropName: string,\n\t\tpageUuid?: string\n\t): Promise<string | null> {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tlet timeout;\n\t\t\tconst onValue = (value: string | null) => {\n\t\t\t\tif (timeout) {\n\t\t\t\t\tclearTimeout(timeout);\n\t\t\t\t}\n\t\t\t\tresolve(value);\n\t\t\t};\n\t\t\tthis.helper.once(ExtensionEventTypes.BROWSER_OPERATION, onValue);\n\t\t\tthis.helper.sendBrowserOperation({\n\t\t\t\ttype: 'get-element-prop-value',\n\t\t\t\tcsspath,\n\t\t\t\tpropName,\n\t\t\t\tpageUuid\n\t\t\t});\n\t\t\ttimeout = setTimeout(() => {\n\t\t\t\tthis.helper.off(ExtensionEventTypes.BROWSER_OPERATION, onValue);\n\t\t\t\treject(new Error('Timeout'));\n\t\t\t}, 5000);\n\t\t});\n\t}\n}\n\nexport class WorkspaceExtensionEntryPointWrapper extends AbstractExtensionEntryPointWrapper<\n\tWorkspaceExtensions.IWorkspaceExtensionEntryPoint\n> {\n\tprivate handlers: {\n\t\t[key in WorkspaceExtensions.WorkspaceEventTypes]: EventHandler<\n\t\t\tWorkspaceExtensions.WorkspaceEvent\n\t\t>;\n\t};\n\tprivate browserHelper: WorkspaceExtensions.IWorkspaceExtensionBrowserHelper;\n\n\tconstructor(\n\t\tentrypoint: WorkspaceExtensions.IWorkspaceExtensionEntryPoint,\n\t\thelper: IExtensionEntryPointHelper\n\t) {\n\t\tsuper(entrypoint, helper);\n\t\tthis.browserHelper = new BrowserHelper(helper);\n\n\t\tthis.handlers = {\n\t\t\t'env-prepare': entrypoint.handleEnvironmentPrepare,\n\t\t\t'story-prepare': entrypoint.handleStoryPrepare,\n\t\t\t'flow-should-start': entrypoint.handleFlowShouldStart,\n\t\t\t'flow-accomplished': entrypoint.handleFlowAccomplished,\n\t\t\t'step-should-start': entrypoint.handleStepShouldStart,\n\t\t\t'step-on-error': entrypoint.handleStepOnError,\n\t\t\t'step-accomplished': entrypoint.handleStepAccomplished,\n\t\t\t'reload-all-handlers': entrypoint.handleReloadAllHandlers,\n\t\t\t'reload-story-handler': entrypoint.handleReloadStoryHandler,\n\t\t\t'reload-flow-handler': entrypoint.handleReloadFlowHandler,\n\t\t\t'reload-step-handler': entrypoint.handleReloadStepHandler\n\t\t};\n\t}\n\tasync handle(event: WorkspaceExtensions.WorkspaceEvent): Promise<void> {\n\t\tconst handler: EventHandler<WorkspaceExtensions.WorkspaceEvent> = this.handlers[event.type];\n\t\tif (handler) {\n\t\t\ttry {\n\t\t\t\tconst result = await handler.call(this.getEntrypoint(), event, this.browserHelper);\n\t\t\t\treturn this.getHelper().sendMessage(result);\n\t\t\t} catch (e) {\n\t\t\t\treturn this.getHelper().sendError(e);\n\t\t\t}\n\t\t} else {\n\t\t\t// console.error(`Handler not found for event[${event.type}]`);\n\t\t\t// console.error(event);\n\t\t\treturn this.getHelper().sendIgnore();\n\t\t}\n\t}\n}\n"]}